# 0604

상위 회의: 6월 (6%E1%84%8B%E1%85%AF%E1%86%AF%204d69b2b7be794120a3f326c2e843eca9.md)

[0604 1차 테스트 ](0604%209e8709a76d7544209c60ffe17530d09f/0604%201%E1%84%8E%E1%85%A1%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%20e21959d3264644b79535f49ee3c960f6.csv)

예외 케이스

 1. 첫 번째 테스트 : 공이 턱에 걸렸다가 간신히 홀에 들어가는 경우 win인데 lose라고 뜨는 문제

카메라 딜레이

1. 두 번째 테스트 : 안쪽 부분을 빙글빙글 돌면서 들어가는 경우 벽 맞았다고 판단 
2. 세 번째 테스트 : 안쪽 부분 돌면서 들어가는 경우, lose로 판단
3. 네 번째 테스트 : 안을 돌면서 + 턱에 걸린 경우 → lose 판단

⇒ 공이 턱에 걸린 경우 , 홀 안을 빙글빙글 도는 경우

😓final_wall.py로 테스트 했음…위의 결과 무시

[0604 테스트 ](0604%209e8709a76d7544209c60ffe17530d09f/0604%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%20d6787ae8b7d84992a13fbeb0766689bd.csv)

예외 케이스

1. lose일 때 위로 갔는데 스트레이트 나옴 → 범위 조정 (어안 카메라 보정 문제…카메라 보정하지 않는 이상 해결 힘들어보임) →시간나면 해결 어안 보정 추가 시행
2. 홀의 끝에서 멈춘 뒤 루즈 판정 → 범위 조정(홀의 끝 범위를 늘려주기)  ~~왜곡이 문제~~  
    - 공이 홀의 끝에서 멈추면 무조건 lose가 뜸… 홀의 위치를 바꾸거나 threashold 값을 정밀하게 조정하는 등 코드상 여러 시도를 해봤지만 해결 불가….하드웨어적으로 처리하기(뒤에 경사를 만들기) ✅
    
    ![Untitled](0604%209e8709a76d7544209c60ffe17530d09f/Untitled.png)
    
3. 홀의 끝에서 멈춘 뒤 루즈 판정(완료 우측도 문제 있어서 보정 완료함) ✅

 9. 전반부에서 벽 맞고 루즈 판정 → 코드 전체 수정? **(전반부에서 벽 맞았는데 win이라고 뜨는 케이스 존재!! 해당 문제 해결해야 함. 볼 샷 영역 이전에 벽을 맞을 경우 인식 못함)**

- 공 위치를 3가지 스테이트로 나눈다
1. 샷 준비 영역
2. 볼샷 예비 영역
3. 볼샷 영역
샷 준비 영역에서는 공 각도 바뀜 인식 x
볼샷 예비 영역에서는 공 각도 바뀜을 인식하고 기억해둠
볼샷 영역에서는 공 각도 바뀜을 인식하고, 기억해둔 각도 바뀜이 있으면 벽 맞음 판

 10. 벽 맞고 윈 판정 → 스레시홀드 미세조정✅

- 공 방향이 바뀌었지만 벽 충돌이 없는 경우, 충돌이라고 간주되는 문제 (일단 해결함)→ 벽 스레시홀드 값 default 5에서 → **2.5**로 설정. 계속 테스트해보며 처리되는지 볼 필요 있음
    
    ```python
    current_direction = utils.temp_return_ball_direction(ball_position[0], ball_position[1], center[0], center[1], previous_direction, 2.5)
                        if previous_direction != current_direction:
                            print('방향 바뀜')
    ```
    

 13. 루즈 판정 안 나옴 → 아마 볼샷 자체가 안 먹음

- 턱에 걸리는 케이스 (턱에 걸렸지만 홀에 들어갔으므로 win이지만, lose라고 판단해버림)✅
    - is_moving이 false를 출력하면 3초동안 기다리면서 공이 움직이는지 안 움직이는지 파악하다가
    다시 움직이면 3초를 초기화해서 3초를 추가로 확인하고 3초간 확실히 멈춘것이 확인되면 그때 골 여부 확인
    - time.time() 설정해 3초 이상 지났을 경우 판별
        
        ```python
        if isMoving.value == False:
        	start = time.time()
        
        	if start >= 3:
        	#det goal
        		if utils.goal(center[0], center[1]):
        			tts_flag.value = const.game_win
        		else:
        			tts_flag.value = const.game_lose
        			# 공의 방향 공의 이동거리
        			#shot_direction = utils.return_ball_direction(prev_ball_position[1], center[1])
        			shot_direction = utils.temp_return_ball_direction(prev_ball_position[0], prev_ball_position[1], center[0], center[1], previous_direction)
        			dist[0] = shot_direction
        			shot_dist = utils.euclidean_distance(prev_ball_position[0],prev_ball_position[1],center[0],center[1])
        			dist[1] = shot_dist
        ```
        
    
    [지수] 위 코드 time 수정
    
    - time.time()은 1970년 1월 1일 0시 0분 0초 기준으로 현재 시간을 체크하는 함수
    - 따라서 3초 timer를 체크하려면 shot이후 공이 멈춘 시간을 저장하고 반복문에서 현재 시간에서 공이 멈춘 시간을 뺀 값이 3초보다 클 경우로 작성해야함
    
    ```python
    #stream_opencv
    now = time.time()
    if isMovingTime[1] == True:
      timer = now - isMovingTime[0]
      if timer >= 3:
    	  #골 여부 판단
    ```
    
    ```python
    #check_movement
     if abs(current_x-prev_ball_position[0]) >= threshold and align_success.value == True:
        if shot_flag.value == False:
            shot_flag.value = True
            if isMovingTime[1] == False:
                isMovingTime[0] = time.time()
                isMovingTime[1] = True
    ```
    
- 정렬 안 됐는데 헤드 공 거리 알려주는 문제 → 배터리 문제 ✅

[예지] 공 방향 관련 유틸 함수 수정

---

홀 범위 

x : 567 - 587

y : 19 - 46

기존 

goal_x = 576

goal_y = 33

x_threshold = 10

y_threshold = 12

수정 

goal_x = 577

goal_y = 33

y_threshold = 13

572 - 585

---

[홀 이동]

x값

가운데 567

전방 :557 

후방 : 572

y값

우측 : 44

좌측 : 21

가운데 : 33

559, 25

---

가운데 : 577, 34

전방 ; 571, 34

후방 : 584, 34

업 : 577, 43

다운 : 579, 24

---

goalx y = 576, 33

가운데 578, 32

전방 : 572, 33

후방 : 585, 33

업 : 578, 43

다운 : 579, 23

---

만약 2차테스트까지 골 쪽 벽 충돌 이슈 해결이 힘들다면

1차 골 직전까지 벽 충돌 문제까지만 해결 

턱에 걸리는케이스

뒤쪽 벽맞고 다시 홀에 들어갈경우 win 예외

앞쪽 벽 맞을 경우

가끔씩 못잡는 문제

벽 스레시홀드 값 2로 주면 방향 바뀌긴 했지만 벽 충돌이 없는 경우도 충돌이라고 간주

---

### Todo

[예외케이스 기록](%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%AC%E1%84%8F%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%89%E1%85%B3%20%E1%84%80%E1%85%B5%E1%84%85%E1%85%A9%E1%86%A8%208939e58fcfd045ecb35fdca2f4484652.md)

- [ ]  전반부(아크릴 벽 시작부분 근처 - 카메라 중간 전쯤까지) 아크릴 벽에 맞았는데도 win이라고 뜨는 예외 케이스 해결(위쪽 예외케이스 노랑색 하이라이트로 칠해진거  아래 3개의 state 참고해서 해결)
- [x]  TTS 속도 조절
    - 200 ⇒ 180으로 변경
    - tts 속도 변경하는 방법
        
        ~/.local/lib/python3.11/site-packages/pyttsx3/espeak.py
        
        ```python
        def __init__ ():
        	self.setProperty('rate', 180)
        ```
        
- [ ]  벽에 맞았는데 안 맞았다고 판단하는 경우, 벽에 안 맞았는데 맞았다고 판단하는 경우 → threshold =2.5로 설정해 해결하고 테스트까지 완료. 하지만 지속적으로 테스트 해보면서 threshold 값이 적절한지 검토 필요
- [ ]  벽맞았는데 win 뜨는 케이스 → 아크릴 뒤 없애고 박스 설치해서 개조하기(장비 받으면 해결하기)
- [ ]  홀 위치 변경
    - 홀 끝쪽으로 갔을 때 공이 안잡혀서 out of range가 됨

---

진행 상황

1. 벽 맞는 케이스
- flag 넣고 확인했더니 벽 관련 예외 케이스가 해결되지 않았다. 현재는 벽 근처/그 외 범위 나눠서 판단하도록 코드 수정한 상태이다. 테스트 해보며 수정 필요하다.
- win인데 벽을 맞았다고 판단되는 경우가 많이 나타남 
이는 홀 위치 변경 후 해결 해야 할 것으로 보임
- **벽에 부딪히지 않았는데 벽에 부딪혔다고 판단하는 걸 해결해야함**

1. timer 코드 수정한 내용 확인 (노션: 파란색 글씨)
- 치고 나서 3초 뒤에 결과 tts가 나온다. 치고 나서 3초 정도 기다려야 한다.

1. 홀 위치 변경 필요
- 골이 홀 끝 쪽에 가면 아예 공이 잡히지 않는 경우가 있다.
- 홀 위치 앞쪽으로 변경 및 x 값 수정 필요하다.

1. 벽에 부딪히지 않고, 홀을 타고 살짝 돌아서 들어가는 경우는 어떻게 판단할지 
- 현재는 `방향 바뀜`으로 뜨고 있다.

1. 예외 케이스 확인을 위해 이제 영상 찍어서 확인하면 좋을 것 같다.